import{s as d}from"./index-d475d2ea.js";const{addons:b}=__STORYBOOK_MODULE_PREVIEW_API__,{once:A,logger:C}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:R,STORY_RENDER_PHASE_CHANGED:D,SET_CURRENT_STORY:j,IGNORED_EXCEPTION:L}=__STORYBOOK_MODULE_CORE_EVENTS__;var S={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},T={start:!1,back:!1,goto:!1,next:!1,end:!1},I=new Error("This function ran after the play function completed. Did you forget to `await` it?"),w=n=>Object.prototype.toString.call(n)==="[object Object]",U=n=>Object.prototype.toString.call(n)==="[object Module]",k=n=>{if(!w(n)&&!U(n))return!1;if(n.constructor===void 0)return!0;const s=n.constructor.prototype;return!(!w(s)||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)},B=n=>{try{return new n.constructor}catch{return{}}},y=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),N=(n,s=!1)=>{const l=(s?n.shadowCalls:n.calls).filter(i=>i.retain);if(!l.length)return;const h=new Map(Array.from(n.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:l.length,calls:l,callRefsByResult:h}},P=class{constructor(){this.initialized=!1,this.channel=b.getChannel(),this.state=d.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};const n=({storyId:e,isPlaying:r=!0,isDebugging:t=!1})=>{const a=this.getState(e);this.setState(e,{...y(),...N(a,t),shadowCalls:t?a.shadowCalls:[],chainedCallIds:t?a.chainedCallIds:new Set,playUntil:t?a.playUntil:void 0,isPlaying:r,isDebugging:t}),this.sync(e)};this.channel.on(R,n),this.channel.on(D,({storyId:e,newPhase:r})=>{const{isDebugging:t}=this.getState(e);this.setState(e,{renderPhase:r}),r==="preparing"&&t&&n({storyId:e}),r==="playing"&&n({storyId:e,isDebugging:t}),r==="played"&&this.setState(e,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(e,{isLocked:!1,isPlaying:!1})}),this.channel.on(j,()=>{this.initialized?this.cleanup():this.initialized=!0});const s=({storyId:e,playUntil:r})=>{this.getState(e).isDebugging||this.setState(e,({calls:a})=>({calls:[],shadowCalls:a.map(_=>({..._,status:"waiting"})),isDebugging:!0}));const t=this.getLog(e);this.setState(e,({shadowCalls:a})=>{var o;if(r||!t.length)return{playUntil:r};const _=a.findIndex(f=>f.id===t[0].callId);return{playUntil:(o=a.slice(0,_).filter(f=>f.interceptable&&!f.ancestors.length).slice(-1)[0])==null?void 0:o.id}}),this.channel.emit(R,{storyId:e,isDebugging:!0})},l=({storyId:e})=>{var a;const r=this.getLog(e).filter(_=>!_.ancestors.length),t=r.reduceRight((_,o,f)=>_>=0||o.status==="waiting"?_:f,-1);s({storyId:e,playUntil:(a=r[t-1])==null?void 0:a.callId})},h=({storyId:e,callId:r})=>{var g;const{calls:t,shadowCalls:a,resolvers:_}=this.getState(e),o=t.find(({id:u})=>u===r),f=a.find(({id:u})=>u===r);if(!o&&f&&Object.values(_).length>0){const u=(g=this.getLog(e).find(p=>p.status==="waiting"))==null?void 0:g.callId;f.id!==u&&this.setState(e,{playUntil:f.id}),Object.values(_).forEach(p=>p())}else s({storyId:e,playUntil:r})},i=({storyId:e})=>{var t;const{resolvers:r}=this.getState(e);if(Object.values(r).length>0)Object.values(r).forEach(a=>a());else{const a=(t=this.getLog(e).find(_=>_.status==="waiting"))==null?void 0:t.callId;a?s({storyId:e,playUntil:a}):c({storyId:e})}},c=({storyId:e})=>{this.setState(e,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(e).resolvers).forEach(r=>r())};this.channel.on(S.START,s),this.channel.on(S.BACK,l),this.channel.on(S.GOTO,h),this.channel.on(S.NEXT,i),this.channel.on(S.END,c)}getState(n){return this.state[n]||y()}setState(n,s){const l=this.getState(n),h=typeof s=="function"?s(l):s;this.state={...this.state,[n]:{...l,...h}},d.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((s,[l,h])=>{const i=N(h);return i&&(s[l]=Object.assign(y(),i)),s},{});const n={controlStates:T,logItems:[]};this.channel.emit(S.SYNC,n),d.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(n){const{calls:s,shadowCalls:l}=this.getState(n),h=[...l];s.forEach((c,e)=>{h[e]=c});const i=new Set;return h.reduceRight((c,e)=>(e.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),e.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(e.interceptable||e.exception)&&!i.has(e.id)&&(c.unshift({callId:e.id,status:e.status,ancestors:e.ancestors}),i.add(e.id)),c),[])}instrument(n,s){if(!k(n))return n;const{mutate:l=!1,path:h=[]}=s;return Object.keys(n).reduce((i,c)=>{const e=n[c];return typeof e!="function"?(i[c]=this.instrument(e,{...s,path:h.concat(c)}),i):typeof e.__originalFn__=="function"?(i[c]=e,i):(i[c]=(...r)=>this.track(c,e,r,s),i[c].__originalFn__=e,Object.defineProperty(i[c],"name",{value:c,writable:!1}),Object.keys(e).length>0&&Object.assign(i[c],this.instrument({...e},{...s,path:h.concat(c)})),i)},l?n:B(n))}track(n,s,l,h){var p,O,m,E;const i=((p=l==null?void 0:l[0])==null?void 0:p.__storyId__)||((E=(m=(O=d.__STORYBOOK_PREVIEW__)==null?void 0:O.selectionStore)==null?void 0:m.selection)==null?void 0:E.storyId),{cursor:c,ancestors:e}=this.getState(i);this.setState(i,{cursor:c+1});const r=`${e.slice(-1)[0]||i} [${c}] ${n}`,{path:t=[],intercept:a=!1,retain:_=!1}=h,o=typeof a=="function"?a(n,t):a,f={id:r,cursor:c,storyId:i,ancestors:e,path:t,method:n,args:l,interceptable:o,retain:_},u=(o&&!e.length?this.intercept:this.invoke).call(this,s,f,h);return this.instrument(u,{...h,mutate:!0,path:[{__callId__:f.id}]})}intercept(n,s,l){const{chainedCallIds:h,isDebugging:i,playUntil:c}=this.getState(s.storyId),e=h.has(s.id);return!i||e||c?(c===s.id&&this.setState(s.storyId,{playUntil:void 0}),this.invoke(n,s,l)):new Promise(r=>{this.setState(s.storyId,({resolvers:t})=>({isLocked:!1,resolvers:{...t,[s.id]:r}}))}).then(()=>(this.setState(s.storyId,r=>{const{[s.id]:t,...a}=r.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(n,s,l)))}invoke(n,s,l){const{callRefsByResult:h,renderPhase:i}=this.getState(s.storyId),c=t=>{var a,_;if(h.has(t))return h.get(t);if(t instanceof Array)return t.map(c);if(t instanceof Date)return{__date__:{value:t.toISOString()}};if(t instanceof Error){const{name:o,message:f,stack:g}=t;return{__error__:{name:o,message:f,stack:g}}}if(t instanceof RegExp){const{flags:o,source:f}=t;return{__regexp__:{flags:o,source:f}}}if(t instanceof d.window.HTMLElement){const{prefix:o,localName:f,id:g,classList:u,innerText:p}=t,O=Array.from(u);return{__element__:{prefix:o,localName:f,id:g,classNames:O,innerText:p}}}return typeof t=="function"?{__function__:{name:t.name}}:typeof t=="symbol"?{__symbol__:{description:t.description}}:typeof t=="object"&&((a=t==null?void 0:t.constructor)!=null&&a.name)&&((_=t==null?void 0:t.constructor)==null?void 0:_.name)!=="Object"?{__class__:{name:t.constructor.name}}:Object.prototype.toString.call(t)==="[object Object]"?Object.fromEntries(Object.entries(t).map(([o,f])=>[o,c(f)])):t},e={...s,args:s.args.map(c)};s.path.forEach(t=>{t!=null&&t.__callId__&&this.setState(s.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(t.__callId__))}))});const r=t=>{if(t instanceof Error){const{name:a,message:_,stack:o,callId:f=s.id}=t,g={name:a,message:_,stack:o,callId:f};if(this.update({...e,status:"error",exception:g}),this.setState(s.storyId,u=>({callRefsByResult:new Map([...Array.from(u.callRefsByResult.entries()),[t,{__callId__:s.id,retain:s.retain}]])})),s.ancestors.length)throw Object.prototype.hasOwnProperty.call(t,"callId")||Object.defineProperty(t,"callId",{value:s.id}),t;if(t!==I)throw C.warn(t),L}throw t};try{if(i==="played"&&!s.retain)throw I;const a=(l.getArgs?l.getArgs(s,this.getState(s.storyId)):s.args).map(o=>typeof o!="function"||Object.keys(o).length?o:(...f)=>{const{cursor:g,ancestors:u}=this.getState(s.storyId);this.setState(s.storyId,{cursor:0,ancestors:[...u,s.id]});const p=()=>this.setState(s.storyId,{cursor:g,ancestors:u});let O=!1;try{const m=o(...f);return m instanceof Promise?(O=!0,m.finally(p)):m}finally{O||p()}}),_=n(...a);return _&&["object","function","symbol"].includes(typeof _)&&this.setState(s.storyId,o=>({callRefsByResult:new Map([...Array.from(o.callRefsByResult.entries()),[_,{__callId__:s.id,retain:s.retain}]])})),this.update({...e,status:_ instanceof Promise?"active":"done"}),_ instanceof Promise?_.then(o=>(this.update({...e,status:"done"}),o),r):_}catch(t){return r(t)}}update(n){this.channel.emit(S.CALL,n),this.setState(n.storyId,({calls:s})=>{const l=s.concat(n).reduce((h,i)=>Object.assign(h,{[i.id]:i}),{});return{calls:Object.values(l).sort((h,i)=>h.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(n.storyId)}sync(n){const s=()=>{var _;const{isLocked:l,isPlaying:h}=this.getState(n),i=this.getLog(n),c=(_=i.filter(({ancestors:o})=>!o.length).find(o=>o.status==="waiting"))==null?void 0:_.callId,e=i.some(o=>o.status==="active");if(l||e||i.length===0){const o={controlStates:T,logItems:i};this.channel.emit(S.SYNC,o);return}const r=i.some(o=>["done","error"].includes(o.status)),a={controlStates:{start:r,back:r,goto:!0,next:h,end:h},logItems:i,pausedAt:c};this.channel.emit(S.SYNC,a)};this.setState(n,({syncTimeout:l})=>(clearTimeout(l),{syncTimeout:setTimeout(s,0)}))}};function M(n,s={}){var l,h,i,c;try{let e=!1,r=!1;return(h=(l=d.window.location)==null?void 0:l.search)!=null&&h.includes("instrument=true")?e=!0:(c=(i=d.window.location)==null?void 0:i.search)!=null&&c.includes("instrument=false")&&(r=!0),d.window.parent===d.window&&!e||r?n:(d.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(d.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new P),d.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(n,s))}catch(e){return A.warn(e),n}}export{M as i};
//# sourceMappingURL=index-341540c2.js.map
